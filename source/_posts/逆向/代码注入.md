---
title: 代码注入
date: 2021-05-25 13:55:24
tags:
    - 应用签名
categories:
    - 逆向
---


# 代码注入

我们按照上一章（应用重签名）的逻辑，先把程序跑起来。

然后再`.app`中显示包内容，查看可执行文件。这里我们使用`MachOView`工具进行分析，这里我们主要查看的是`Load Commands`。

![](MachOView.jpg)

`Load Commands`：加载命令。

在`Load Commands`里头，可以看到所有的Framework。点击每一个Framework可以看到这个Framework的执行路径。


## Framework注入

### 创建动态库

1. 在工程中选择`WeChat.xcodeproj`，然后在工程配置页面，选择左下角的加号”+“ -> ”iOS“ -> search ”Framework“。

    ![](add_framework.jpg)

2. 创建一个类，添加`+(void)load`方法，打印一串字符串。

    ```
    + (void)load {
        NSLog(@"\n\n hock success...\n\n");
    }
    ```


3. 重新运行工程（使用重签名）。这个时候我们的`NSLog`并不会执行，因为并没有链接到可执行文件。


    然后在项目工程`project` -> `show in finder` -> 找到对应的APP -> 显示包内容 -> Framework文件夹。可以看到我们添加的ALHook.framework。

    然后重新用`MachOView`工具打开可以执行文件（需要这个可执行文件），看看是否有链接ALHook.framework。这里是没有的。

### 链接动态库

通过`yololib`工具修改Mach-O文件，目的就是链接我们添加的动态库。

把`yololib`工具放到我们的工程文件中，与`appSign.sh`文件同级。然后把上面debug的可执行文件也同样复制过来。

然后执行下面的命令。

```
$ ./yololib [可执行文件] Frameworks/[添加的动态库].framework/[添加的动态库的可执行文件]

$ ./yololib WeChat Frameworks/ALHook.framework/ALHook
```

执行完命令之后，重新使用`MachOView`工具打开可执行文件。

![](MachO_ALHook.jpg)


### 重新压缩，打包ipa文件

1. 重新解压`8.0.2.ipa`文件。
2. 替换`Payload/xx.app -> 显示包内容`中的可执行文件，把上一部链接好的可执行文件做替换。
3. 重新压缩 `$ zip -ry WeChat.ipa Payload/`。
4. 把压缩后的ipa包重新放在工程目录APP文件夹下。

### 重新运行
    
这个时候重新运行，就可以看到我们的NSLog了。


## dylib注入



